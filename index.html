<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الرواتب المتطور</title>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبة التعامل مع Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- === مكتبات Firebase === -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #1e3a8a; /* الأزرق الغامق */
            --primary-light: #3b82f6;
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --success: #15803d;
            --danger: #b91c1c;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); direction: rtl; min-height: 100vh; margin: 0; }
        
        /* === شاشة تسجيل الدخول === */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; font-weight: 800; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .login-box button:hover { background: #172554; }
        .error-msg { color: #dc2626; font-size: 0.9rem; margin-top: 15px; display: none; font-weight: bold; background: #fee2e2; padding: 10px; border-radius: 5px; }

        /* === النظام الرئيسي === */
        #appContainer { display: none; display: flex; width: 100%; min-height: 100vh; }
        
        /* القائمة الجانبية */
        .sidebar { width: 260px; background: #0f172a; color: white; height: 100vh; position: fixed; right: 0; top: 0; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar .brand { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .sidebar nav { padding: 10px; flex-grow: 1; }
        .sidebar nav li { padding: 12px 20px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; font-weight: 500; }
        .sidebar nav li:hover, .sidebar nav li.active { background: var(--primary-light); color: white; }
        .user-info { padding: 20px; background: rgba(0,0,0,0.2); font-size: 0.85rem; color: #e2e8f0; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }

        /* المحتوى */
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 25px; }
        
        .filters-header { background: #fff; padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; border-bottom: 1px solid #f1f5f9; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: #64748b; }
        .input-group input, .input-group select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; min-width: 160px; font-family: inherit; font-size: 0.95rem; }
        
        /* الأزرار */
        button { border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: bold; display: flex; gap: 8px; align-items: center; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: #1e40af; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: #334155; } .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: #fee2e2; color: #991b1b; } .btn-danger:hover { background: #fecaca; }
        .btn-success { background: #dcfce7; color: #166534; } .btn-success:hover { background: #bbf7d0; }
        .btn-save { background: #0f172a; color: white; width: 100%; justify-content: center; padding: 12px; font-size: 1rem; } .btn-save:hover { background: #000; }

        /* منطقة العمل */
        .workspace { display: grid; grid-template-columns: 280px 1fr; gap: 25px; align-items: start; }
        .emp-list { list-style: none; height: 600px; overflow-y: auto; padding: 10px; }
        .emp-list li { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items:center; border-radius: 6px; margin-bottom: 4px; transition: 0.1s; }
        .emp-list li:hover { background: #f1f5f9; }
        .emp-list li.selected { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        
        .form-container { padding: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .section-header { grid-column: 1/-1; margin: 15px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; color: var(--primary); font-weight: bold; }
        
        /* جدول البصمة */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .attendance-table th { background: #f8fafc; padding: 10px; text-align: center; border-bottom: 1px solid var(--border); font-weight: bold; }
        .attendance-table td { padding: 5px; border-bottom: 1px solid var(--border); text-align: center; }
        .attendance-table input { width: 100%; border: none; text-align: center; background: transparent; padding: 5px; font-family: monospace; font-size: 1rem; }
        .attendance-table input:focus { background: #eff6ff; }

        /* ============================== */
        /* === تصميم الطباعة === */
        /* ============================== */
        .preview-wrapper-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .salary-card { 
            background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; page-break-inside: avoid; 
            font-family: 'Tajawal', sans-serif;
        }
        .salary-card .card-header { 
            background-color: #1e3a8a !important; 
            color: white !important; 
            padding: 10px; 
            text-align: center; 
            font-weight: 800; 
            font-size: 1.1rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .salary-card table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .salary-card td { padding: 6px 10px; border-bottom: 1px solid #eee; }
        .salary-card .label-col { 
            text-align: right; color: #555; font-weight: 600; width: 50%; border-left: 1px solid #eee; background: #fafafa;
        }
        .salary-card .value-col { 
            text-align: center; color: #000; font-weight: bold; width: 50%; font-family: monospace; font-size: 1rem;
        }
        .salary-card .net-row td { 
            background-color: #ecfdf5 !important; 
            border-top: 2px solid #000; 
            padding: 10px; 
            font-size: 1.2rem; 
            font-weight: 900;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .salary-card .val-red { color: #b91c1c; }
        .salary-card .val-green { color: #15803d; }

        .branch-summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; page-break-inside: auto; }
        .branch-summary-table th { 
            background-color: #f1f5f9 !important; border: 1px solid #ccc; padding: 10px; font-weight: bold;
            -webkit-print-color-adjus: exact;
        }
        .branch-summary-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .branch-summary-table tr:nth-child(even) { background-color: #fcfcfc; }

        @media print {
            .sidebar, .main-content > div:not(#printView), .no-print, .filters-header, button { display: none !important; }
            body, .main-content { margin: 0; padding: 0; background: white; width: 100%; }
            #printView, #printPreviewContainer { display: block !important; }
            .preview-wrapper-cards { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 10px !important; }
            .salary-card { border: 2px solid #000 !important; margin-bottom: 15px; box-shadow: none !important; }
        }
    </style>
</head>
<body>

    <!-- === شاشة تسجيل الدخول === -->
    <div id="loginScreen">
        <div class="login-box">
            <h2>نظام الرواتب <i class="fa-solid fa-lock"></i></h2>
            <p style="margin-bottom:15px; color:#666">يرجى تسجيل الدخول للمتابعة</p>
            <input type="email" id="loginEmail" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPass" placeholder="كلمة المرور">
            <button onclick="loginUser()">دخول للنظام</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <!-- === التطبيق الرئيسي === -->
    <div id="appContainer">
        
        <div class="sidebar no-print">
            <div class="brand">
                <i class="fa-solid fa-sack-dollar"></i>
                <span> Mahmoud
                    Fingerprint Sheet</span>
            </div>
            <nav>
                <li class="active" onclick="switchView('main')"><i class="fa-solid fa-users"></i> الموظفين</li>
                <li onclick="switchView('print')"><i class="fa-solid fa-print"></i> طباعة الرواتب</li>
                <li onclick="switchView('settings')"><i class="fa-solid fa-gear"></i> الإعدادات</li>
            </nav>
            <div class="user-info">
                <div style="margin-bottom:5px; font-weight:bold" id="currentUserDisplay">...</div>
                <button class="btn-danger" onclick="logoutUser()" style="width:100%; justify-content:center; font-size:0.8rem; padding:6px">
                    <i class="fa-solid fa-sign-out-alt"></i> تسجيل خروج
                </button>
            </div>
        </div>

        <div class="main-content">
            
            <!-- === قسم الموظفين === -->
            <div id="mainView">
                <div class="card no-print">
                    <div class="filters-header">
                        <div class="input-group">
                            <label>الفرع الحالي</label>
                            <select id="branchSelect" onchange="renderEmployees()"></select>
                        </div>
                        <div class="input-group">
                            <label>شهر الراتب</label>
                            <input type="month" id="monthSelect" onchange="renderEmployees()">
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <button class="btn-success" onclick="document.getElementById('excelInput').click()">
                            <i class="fa-solid fa-file-excel"></i> استيراد (Excel)
                        </button>
                        <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls">
                        <button class="btn-secondary" onclick="resetForm()">
                            <i class="fa-solid fa-plus"></i> موظف جديد
                        </button>
                    </div>
                </div>

                <div class="workspace">
                    <!-- القائمة الجانبية للموظفين -->
                    <div class="card no-print">
                        <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #eee; font-weight:bold">
                            موظفي الفرع
                            <span style="font-size:0.7rem; color:#666; display:block; font-weight:normal" id="statusMsg">جاري الاتصال...</span>
                        </div>
                        <ul class="emp-list" id="employeesList"></ul>
                    </div>

                    <!-- نموذج الإدخال -->
                    <div class="card form-container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">
                            <h2 id="formTitle" style="font-size:1.4rem; color:var(--primary)">موظف جديد</h2>
                            <button class="btn-danger" id="btnDeleteRecord" style="display:none" onclick="deleteEmployeeRecord()">
                                <i class="fa-solid fa-trash"></i> حذف سجل هذا الشهر
                            </button>
                        </div>
                        
                        <div class="form-grid">
                            <div class="section-header">البيانات الأساسية</div>
                            <div class="input-group"><label>اسم الموظف</label><input type="text" id="empName"></div>
                            <div class="input-group"><label>رقم البصمة (ID)</label><input type="number" id="empId" placeholder="هام لربط البصمة"></div>
                            <div class="input-group"><label>المسمى الوظيفي</label><input type="text" id="jobTitle"></div>
                            
                            <div class="section-header">الماليات (لهذا الشهر)</div>
                            <div class="input-group"><label>الأساسي (ج.م)</label><input type="number" id="dailyWage"></div>
                            <div class="input-group"><label>حوافز / إضافي</label><input type="number" id="bonus"></div>
                            
                            <div class="section-header">الخصومات</div>
                            <div class="input-group"><label>سلف</label><input type="number" id="loans"></div>
                            <div class="input-group"><label>تقسيط السلفة (شهور)</label><input type="number" id="loanMonths" value="1"></div>
                            <div class="input-group"><label>خصم تأمينات</label><input type="number" id="insurance"></div>
                            <div class="input-group"><label>سحب يوم 10</label><input type="number" id="withdraw10"></div>
                            <div class="input-group"><label>سحب يوم 20</label><input type="number" id="withdraw20"></div>
                            <div class="input-group"><label>جزاءات</label><input type="number" id="generalDeduct"></div>
                        </div>

                        <!-- جدول البصمة -->
                        <div style="margin-top:20px">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <h4 style="margin:0">سجل الحضور</h4>
                                <button class="btn-secondary" onclick="loadAttendanceFromDB()" style="padding:5px 10px; font-size:0.8rem">
                                    <i class="fa-solid fa-cloud-download-alt"></i> جلب بيانات البصمة
                                </button>
                            </div>
                            <div class="table-wrap" style="max-height:300px; overflow-y:auto">
                                <table class="attendance-table" id="attTable">
                                    <thead><tr><th>اليوم</th><th>دخول</th><th>خروج</th><th>ساعات</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div style="margin-top:25px">
                            <button class="btn-save" onclick="saveEmployee()">
                                <i class="fa-solid fa-save"></i> حفظ البيانات لهذا الشهر
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === قسم معاينة الطباعة === -->
            <div id="printView" style="display:none">
                <div class="card no-print" style="padding:30px; text-align:center">
                    <h2 style="color:var(--primary); margin-bottom:10px">طباعة الرواتب</h2>
                    <div style="display:flex; justify-content:center; gap:20px">
                        <button class="btn-primary" onclick="window.print()">
                            <i class="fa-solid fa-print"></i> طباعة
                        </button>
                        <button class="btn-secondary" onclick="preparePrint('cards')">
                            <i class="fa-solid fa-id-card"></i> عرض الكروت
                        </button>
                        <button class="btn-secondary" onclick="preparePrint('list')">
                            <i class="fa-solid fa-list"></i> عرض القائمة الكاملة
                        </button>
                        <button class="btn-danger" onclick="switchView('main')">عودة</button>
                    </div>
                </div>
                <div id="printPreviewContainer"></div>
            </div>

            <!-- === قسم الإعدادات === -->
            <div id="settingsView" style="display:none">
                <div class="card" style="padding:30px; max-width:800px; margin:0 auto">
                    <h3 style="color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px">
                        <i class="fa-solid fa-user-plus"></i> إضافة مستخدم جديد
                    </h3>
                    <div style="background:#f0f9ff; padding:20px; border-radius:8px; border:1px solid #bae6fd">
                        <div style="display:grid; gap:10px; grid-template-columns: 1fr 1fr auto;">
                            <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني الجديد">
                            <input type="password" id="newUserPass" placeholder="كلمة المرور">
                            <button class="btn-primary" onclick="createNewUser()">إنشاء</button>
                        </div>
                    </div>

                    <h3 style="margin-top:40px; border-bottom:1px solid #eee; padding-bottom:10px">إدارة الفروع</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px; margin-top:15px">
                        <input type="text" id="newBranchName" placeholder="اسم الفرع الجديد..." style="flex:1;">
                        <button class="btn-primary" onclick="addBranch()">إضافة فرع</button>
                    </div>
                    <ul id="branchesListDisplay" style="list-style:none;"></ul>
                </div>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. إعدادات Firebase
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyCZj1ur4bW6YPkWS1JCXLruTZXlZG1pHhY",
      authDomain: "fingerprint-sheet.firebaseapp.com",
      projectId: "fingerprint-sheet",
      storageBucket: "fingerprint-sheet.firebasestorage.app",
      messagingSenderId: "673025647746",
      appId: "1:673025647746:web:a0678f010b6367b932c09b",
      measurementId: "G-3DNFBZB0WJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ==========================================
    // 2. المتغيرات
    // ==========================================
    let localEmployees = []; 
    let branches = ['الفرع الرئيسي'];
    let attendanceBuffer = {}; 
    let currentPrintMode = 'cards'; 
    
    // ==========================================
    // 3. إدارة المستخدم
    // ==========================================
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('currentUserDisplay').innerHTML = user.email;
            loadInitialData(); 
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
    });

    function loginUser() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        const errBox = document.getElementById('loginError');
        errBox.style.display = 'none';
        
        if(!email || !pass) { errBox.innerText = "أدخل البيانات"; errBox.style.display = 'block'; return; }

        auth.signInWithEmailAndPassword(email, pass).catch(error => {
            errBox.style.display = 'block';
            errBox.innerText = "خطأ في الدخول: " + error.code;
        });
    }
    function logoutUser() { auth.signOut(); }
    function createNewUser() {
        const email = document.getElementById('newUserEmail').value;
        const pass = document.getElementById('newUserPass').value;
        if(!email || !pass) return alert("أكمل البيانات");
        auth.createUserWithEmailAndPassword(email, pass)
            .then(() => { alert("تم الإنشاء"); document.getElementById('newUserEmail').value=''; document.getElementById('newUserPass').value=''; })
            .catch(e => alert(e.message));
    }

    // ==========================================
    // 4. تحميل البيانات
    // ==========================================
    function loadInitialData() {
        document.getElementById('statusMsg').innerText = "جاري المزامنة...";
        
        db.collection('branches').onSnapshot(snapshot => {
            branches = [];
            snapshot.forEach(doc => branches.push(doc.data().name));
            if(branches.length === 0) branches = ['الفرع الرئيسي'];
            updateUI();
        });

        db.collection('employees').onSnapshot(snapshot => {
            localEmployees = [];
            snapshot.forEach(doc => localEmployees.push(doc.data()));
            renderEmployees();
            document.getElementById('statusMsg').innerText = "متصل";
        });

        const d = new Date();
        document.getElementById('monthSelect').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        initAttTable();
    }

    // ==========================================
    // 5. الواجهة
    // ==========================================
    function switchView(view) {
        document.getElementById('mainView').style.display = view === 'main' ? 'block' : 'none';
        document.getElementById('printView').style.display = view === 'print' ? 'block' : 'none';
        document.getElementById('settingsView').style.display = view === 'settings' ? 'block' : 'none';
        
        document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
        if(view === 'main') document.querySelector('.sidebar li:nth-child(1)').classList.add('active');
        if(view === 'print') {
            document.querySelector('.sidebar li:nth-child(2)').classList.add('active');
            preparePrint('cards'); 
        }
        if(view === 'settings') document.querySelector('.sidebar li:nth-child(3)').classList.add('active');
    }

    function updateUI() {
        const sel = document.getElementById('branchSelect');
        const curr = sel.value;
        sel.innerHTML = '';
        branches.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
        if(branches.includes(curr)) sel.value = curr; else if(branches.length>0) sel.value = branches[0];

        const list = document.getElementById('branchesListDisplay');
        list.innerHTML = '';
        branches.forEach(b => {
            list.innerHTML += `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between"><span>${b}</span> <button class="btn-danger" style="padding:4px 8px" onclick="delBranch('${b}')">حذف</button></li>`;
        });
        renderEmployees();
    }

    // ==========================================
    // 6. إدارة الموظفين
    // ==========================================
    function renderEmployees() {
        const branch = document.getElementById('branchSelect').value;
        const currentMonth = document.getElementById('monthSelect').value;
        const list = document.getElementById('employeesList');
        list.innerHTML = '';

        let branchEmployees = localEmployees.filter(e => e.branch === branch);

        const uniqueMap = new Map();
        branchEmployees.forEach(emp => {
            if(!uniqueMap.has(emp.id)) {
                uniqueMap.set(emp.id, emp);
            } else {
                const existing = uniqueMap.get(emp.id);
                if(emp.month === currentMonth) {
                    uniqueMap.set(emp.id, emp);
                }
            }
        });

        const uniqueEmps = Array.from(uniqueMap.values()).sort((a,b) => a.name.localeCompare(b.name));

        if(uniqueEmps.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">لا يوجد موظفين في هذا الفرع.</li>';
            return;
        }

        uniqueEmps.forEach(emp => {
            const isRegisteredInCurrentMonth = localEmployees.some(e => e.id === emp.id && e.branch === branch && e.month === currentMonth);
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div><span style="font-weight:bold">${emp.name}</span> <br><small>ID: ${emp.id}</small></div>
                <div class="status-dot ${isRegisteredInCurrentMonth ? 'status-active' : 'status-inactive'}" 
                     style="background-color: ${isRegisteredInCurrentMonth ? 'var(--success)' : '#cbd5e1'}" 
                     title="${isRegisteredInCurrentMonth ? 'مسجل هذا الشهر' : 'غير مسجل هذا الشهر'}"></div>
            `;
            li.onclick = () => loadEmpForm(emp.id, emp);
            
            if(document.getElementById('empId').value == emp.id) li.classList.add('selected');
            list.appendChild(li);
        });
    }

    function resetForm() {
        document.querySelectorAll('.form-grid input').forEach(i => i.value = '');
        document.getElementById('loanMonths').value = '1';
        document.getElementById('formTitle').innerText = 'موظف جديد';
        document.getElementById('empId').disabled = false;
        document.getElementById('btnDeleteRecord').style.display = 'none';
        initAttTable();
        document.querySelectorAll('.emp-list li').forEach(li => li.classList.remove('selected'));
    }

    function loadEmpForm(id, masterData) {
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;

        let emp = localEmployees.find(e => e.id === id && e.branch === branch && e.month === month);

        if (emp) {
            fillFormData(emp);
            document.getElementById('formTitle').innerText = 'تعديل: ' + emp.name;
            document.getElementById('btnDeleteRecord').style.display = 'block';
        } else {
            resetForm(); 
            document.getElementById('empName').value = masterData.name;
            document.getElementById('empId').value = masterData.id;
            document.getElementById('jobTitle').value = masterData.job;
            document.getElementById('dailyWage').value = masterData.financials.wage;
            
            document.getElementById('bonus').value = '';
            document.getElementById('loans').value = '';
            document.getElementById('insurance').value = ''; 
            
            document.getElementById('formTitle').innerText = 'تسجيل شهر جديد: ' + masterData.name;
            document.getElementById('btnDeleteRecord').style.display = 'none';
        }

        document.getElementById('empId').disabled = true;
        const listItems = document.querySelectorAll('.emp-list li');
        listItems.forEach(li => li.classList.remove('selected'));
    }

    function fillFormData(emp) {
        document.getElementById('empName').value = emp.name;
        document.getElementById('empId').value = emp.id;
        document.getElementById('jobTitle').value = emp.job;
        document.getElementById('dailyWage').value = emp.financials.wage;
        document.getElementById('bonus').value = emp.financials.bonus;
        document.getElementById('loans').value = emp.financials.loans;
        document.getElementById('loanMonths').value = emp.financials.loanMonths;
        document.getElementById('insurance').value = emp.financials.insurance;
        document.getElementById('withdraw10').value = emp.financials.withdraw10 || 0;
        document.getElementById('withdraw20').value = emp.financials.withdraw20 || 0;
        document.getElementById('generalDeduct').value = emp.financials.deduct;

        initAttTable();
        if(emp.att) {
            Object.entries(emp.att).forEach(([day, val]) => {
                const tr = document.querySelector(`tr[data-day="${day}"]`);
                if(tr) {
                    tr.querySelector('.in').value = val.in;
                    tr.querySelector('.out').value = val.out;
                    calcRow(tr);
                }
            });
        }
    }

    function saveEmployee() {
        const id = document.getElementById('empId').value.trim();
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        const name = document.getElementById('empName').value.trim();

        if(!id || !name) return alert('أدخل الاسم ورقم البصمة');

        const docId = `${branch}_${month}_${id}`; 

        const empData = {
            id, name, branch, month,
            job: document.getElementById('jobTitle').value,
            financials: {
                wage: Number(document.getElementById('dailyWage').value) || 0,
                bonus: Number(document.getElementById('bonus').value) || 0,
                loans: Number(document.getElementById('loans').value) || 0,
                loanMonths: Number(document.getElementById('loanMonths').value) || 1,
                insurance: Number(document.getElementById('insurance').value) || 0,
                withdraw10: Number(document.getElementById('withdraw10').value) || 0,
                withdraw20: Number(document.getElementById('withdraw20').value) || 0,
                deduct: Number(document.getElementById('generalDeduct').value) || 0,
            },
            att: getAttTableData(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection('employees').doc(docId).set(empData)
            .then(() => alert('تم الحفظ بنجاح'))
            .catch(err => alert("خطأ: " + err.message));
    }

    function deleteEmployeeRecord() {
        if(!confirm('حذف سجل هذا الشهر فقط؟')) return;
        const id = document.getElementById('empId').value;
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        const docId = `${branch}_${month}_${id}`;
        db.collection('employees').doc(docId).delete().then(() => { alert('تم الحذف'); resetForm(); });
    }

    // ==========================================
    // 7. حسابات الجدول
    // ==========================================
    function initAttTable() {
        const tbody = document.querySelector('#attTable tbody');
        tbody.innerHTML = '';
        for(let i=1; i<=31; i++) {
            tbody.innerHTML += `<tr data-day="${i}"><td>${i}</td><td><input type="time" class="in" onchange="calcRow(this.closest('tr'))"></td><td><input type="time" class="out" onchange="calcRow(this.closest('tr'))"></td><td class="hours" style="font-weight:bold;color:#666">0.00</td></tr>`;
        }
    }
    function calcRow(tr) {
        const i = tr.querySelector('.in').value; const o = tr.querySelector('.out').value;
        const hCell = tr.querySelector('.hours');
        if(i && o) {
            let d1 = new Date(`2000-01-01T${i}`), d2 = new Date(`2000-01-01T${o}`);
            let diff = (d2 - d1)/36e5; if(diff < 0) diff += 24;
            hCell.innerText = diff.toFixed(2);
        } else hCell.innerText = '0.00';
    }
    function getAttTableData() {
        const data = {};
        document.querySelectorAll('#attTable tbody tr').forEach(tr => {
            const i = tr.querySelector('.in').value; const o = tr.querySelector('.out').value;
            if(i || o) data[tr.dataset.day] = {in:i, out:o};
        });
        return data;
    }

    // ==========================================
    // Excel Logic (المعدل لمنع التكرار)
    // ==========================================
    document.getElementById('excelInput').addEventListener('change', function(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const workbook = XLSX.read(evt.target.result, {type:'array'});
            const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
            attendanceBuffer = {}; let count = 0;
            
            sheet.forEach((row, idx) => {
                if(idx === 0) return; // تخطي العنوان
                
                // قراءة البيانات من الأعمدة (العمود C هو ID، العمود D هو التاريخ والوقت)
                let id = row[2], dateRaw = row[3]; 
                
                if(id && dateRaw) {
                    id = id.toString().trim(); // تنظيف الـ ID
                    
                    // تحويل التاريخ (سواء كان رقم Excel أو نص)
                    let dateObj = typeof dateRaw === 'number' ? new Date((dateRaw - 25569)*86400*1000) : new Date(dateRaw);
                    
                    if(!isNaN(dateObj)) {
                        const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                        const day = dateObj.getDate();
                        const time = `${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
                        
                        const key = `${id}_${monthKey}`;
                        if(!attendanceBuffer[key]) attendanceBuffer[key] = {};
                        if(!attendanceBuffer[key][day]) attendanceBuffer[key][day] = [];
                        
                        // إضافة الوقت للقائمة (سيتم فلترة التكرار لاحقاً عند العرض)
                        attendanceBuffer[key][day].push(time);
                        count++;
                    }
                }
            });
            alert(`تم قراءة ${count} بصمة. اضغط على "جلب بيانات البصمة" داخل الموظف لتطبيقها.`);
        };
        reader.readAsArrayBuffer(file); e.target.value = '';
    });

    // دالة جلب البصمة (تم تحديثها لمنع التكرار وأخذ أول دخول وآخر خروج فقط)
    function loadAttendanceFromDB() {
        // التأكد من أن الـ ID نص للمقارنة الصحيحة
        const id = document.getElementById('empId').value.toString().trim();
        const month = document.getElementById('monthSelect').value;
        const key = `${id}_${month}`;

        if(attendanceBuffer[key]) {
            let daysUpdated = 0;
            Object.keys(attendanceBuffer[key]).forEach(day => {
                // 1. إزالة التكرار المطابق تماماً باستخدام Set
                let times = [...new Set(attendanceBuffer[key][day])];
                
                // 2. ترتيب الأوقات تصاعدياً (من الصباح للمساء)
                times.sort();
                
                const tr = document.querySelector(`tr[data-day="${day}"]`);
                if(tr && times.length > 0) {
                    // أول وقت هو الدخول
                    tr.querySelector('.in').value = times[0];
                    
                    // إذا كان هناك أكثر من وقت، آخر وقت هو الخروج
                    // (يتم تجاهل أي بصمات في المنتصف تلقائياً)
                    if(times.length > 1) {
                        tr.querySelector('.out').value = times[times.length-1];
                    }
                    
                    calcRow(tr); // إعادة حساب الساعات
                    daysUpdated++;
                }
            });
            alert(`تم تحديث بيانات ${daysUpdated} يوم لهذا الموظف.`);
        } else {
            alert("لا توجد بيانات بصمة لهذا الرقم (ID) في هذا الشهر داخل ملف الإكسل المستورد.");
        }
    }

    // ==========================================
    // 8. الطباعة (الكروت + القائمة)
    // ==========================================
    function preparePrint(mode) {
        const container = document.getElementById('printPreviewContainer');
        container.innerHTML = '';
        container.className = (mode === 'cards') ? 'preview-wrapper-cards' : '';
        
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        const filtered = localEmployees.filter(e => e.branch === branch && e.month === month);
        
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">لا توجد بيانات مسجلة لهذا الشهر.</p>';
            return;
        }

        if(mode === 'cards') {
            let html = '';
            filtered.forEach(emp => {
                const c = calculateSalary(emp);
                html += `
                <div class="salary-card">
                    <div class="card-header">${emp.name}</div>
                    <table>
                        <tr> <td class="value-col">${emp.branch}</td> <td class="label-col">الفرع</td> </tr>
                        <tr> <td class="value-col">${emp.month}</td> <td class="label-col">الشهر</td> </tr>
                        <tr> <td class="value-col">${c.workDays}</td> <td class="label-col">أيام العمل</td> </tr>
                        <tr> <td class="value-col">${c.overtimeHours.toFixed(2)}</td> <td class="label-col">ساعات إضافية</td> </tr>
                        <tr> <td class="value-col">${c.delayHours.toFixed(2)}</td> <td class="label-col">ساعات تأخير</td> </tr>
                        <tr> <td class="value-col">${(emp.financials.wage * c.workDays).toFixed(2)}</td> <td class="label-col">الأساسي</td> </tr>
                        <tr> <td class="value-col val-green">${(emp.financials.bonus || 0).toFixed(2)}</td> <td class="label-col">إضافي</td> </tr>
                        <tr> <td class="value-col val-red">${c.delayValue.toFixed(2)}</td> <td class="label-col">خصم تأخير</td> </tr>
                        <tr> <td class="value-col val-red">${c.loanDeduct.toFixed(2)}</td> <td class="label-col">سلف</td> </tr>
                        <tr> <td class="value-col val-red">${(emp.financials.insurance || 0).toFixed(2)}</td> <td class="label-col">تأمينات</td> </tr>
                        <tr> <td class="value-col val-red">${(emp.financials.deduct || 0).toFixed(2)}</td> <td class="label-col">جزاءات</td> </tr>
                        <tr> <td class="value-col val-red">${(c.withdrawals).toFixed(2)}</td> <td class="label-col">مسحوبات</td> </tr>
                        <tr class="net-row"> 
                            <td class="value-col">${c.net.toFixed(2)}</td> 
                            <td class="label-col">الصافي</td> 
                        </tr>
                    </table>
                </div>`;
            });
            container.innerHTML = html;

        } else {
            const dateObj = new Date(month + "-01");
            const monthName = dateObj.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
            
            let html = `
            <div style="text-align:center; margin-bottom:20px;">
                <h2>جميع الموظفين - ${monthName}</h2>
            </div>
            <table class="branch-summary-table">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الوظيفة</th>
                        <th>صافي المرتب</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            filtered.forEach(emp => {
                const c = calculateSalary(emp);
                html += `
                <tr>
                    <td>${emp.name}</td>
                    <td>${emp.job || '-'}</td>
                    <td style="font-weight:bold; direction:ltr">${c.net.toFixed(2)}</td>
                </tr>`;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
    }

    function calculateSalary(emp) {
        let workDays = 0, overtimeHours = 0, delayHours = 0;
        if(emp.att) {
            Object.values(emp.att).forEach(v => {
                if(v.in && v.out) {
                    workDays++;
                    let d1 = new Date("2000-01-01T"+v.in);
                    let d2 = new Date("2000-01-01T"+v.out);
                    let hours = (d2 - d1) / 36e5;
                    if(hours < 0) hours += 24;
                    if(hours > 8) overtimeHours += (hours - 8);
                    if(hours < 8) delayHours += (8 - hours);
                }
            });
        }
        
        const wage = emp.financials.wage || 0;
        const hourlyRate = wage / 8; 
        
        const basicSalary = workDays * wage;
        const delayValue = delayHours * hourlyRate;
        const loanDeduct = (emp.financials.loans || 0) / (emp.financials.loanMonths || 1);
        const withdrawals = (emp.financials.withdraw10 || 0) + (emp.financials.withdraw20 || 0);
        
        const totalDeduct = delayValue + loanDeduct + (emp.financials.insurance || 0) + (emp.financials.deduct || 0) + withdrawals;
        const net = (basicSalary + (emp.financials.bonus || 0)) - totalDeduct;

        return { 
            workDays, overtimeHours, delayHours, delayValue, 
            loanDeduct, withdrawals, net 
        };
    }

    // ==========================================
    // 9. إدارة الفروع
    // ==========================================
    function addBranch() {
        const name = document.getElementById('newBranchName').value;
        if(name && !branches.includes(name)) {
            db.collection('branches').add({ name }).then(() => { alert("تم"); document.getElementById('newBranchName').value=''; });
        }
    }
    function delBranch(name) {
        if(confirm("حذف؟")) db.collection('branches').where('name','==',name).get().then(s => s.forEach(d => d.ref.delete()));
    }

</script>
</body>
</html>
