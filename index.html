html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الرواتب المتكامل - الإصدار المطور</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --success: #15803d;
            --danger: #b91c1c;
            --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); direction: rtl; display: flex; min-height: 100vh; }
        
        /* === القائمة الجانبية === */
        .sidebar { width: 260px; background: #0f172a; color: white; height: 100vh; position: fixed; right: 0; top: 0; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar .brand { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .sidebar nav { padding: 10px; }
        .sidebar nav li { padding: 12px 20px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; font-weight: 500; }
        .sidebar nav li:hover, .sidebar nav li.active { background: var(--primary-light); color: white; }
        
        /* === المحتوى الرئيسي === */
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 25px; }
        
        /* === الفلاتر === */
        .filters-header { background: #fff; padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; border-bottom: 1px solid #f1f5f9; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: #64748b; }
        .input-group input, .input-group select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; min-width: 160px; font-family: inherit; font-size: 0.95rem; }
        .input-group input:focus, .input-group select:focus { border-color: var(--primary-light); border: 2px solid #eff6ff; }
        
        /* === الأزرار === */
        button { border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: bold; display: flex; gap: 8px; align-items: center; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: #172554; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: #334155; } .btn-secondary:hover { background: #f8fafc; border-color: var(--primary-light); }
        .btn-danger { background: #fee2e2; color: #991b1b; } .btn-danger:hover { background: #fecaca; }
        .btn-success { background: #dcfce7; color: #166534; } .btn-success:hover { background: #bbf7d0; }
        .btn-save { background: #0f172a; color: white; width: 100%; justify-content: center; padding: 12px; font-size: 1rem; } .btn-save:hover { background: #000; }

        /* === الشبكة والنموذج === */
        .workspace { display: grid; grid-template-columns: 280px 1fr; gap: 25px; align-items: start; }
        
        /* قائمة الموظفين */
        .emp-list { list-style: none; height: 600px; overflow-y: auto; padding: 10px; }
        .emp-list li { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items:center; border-radius: 6px; margin-bottom: 4px; transition: 0.1s; }
        .emp-list li:hover { background: #f1f5f9; }
        .emp-list li.selected { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-left:5px; }
        .status-active { background-color: var(--success); }
        .status-inactive { background-color: #cbd5e1; }

        /* النموذج */
        .form-container { padding: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .section-header { grid-column: 1/-1; margin: 15px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; color: var(--primary); font-weight: bold; font-size: 1rem; }
        
        /* جدول البصمة */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .attendance-table th { background: #f8fafc; padding: 10px; text-align: center; border-bottom: 1px solid var(--border); font-weight: 700; }
        .attendance-table td { padding: 5px; border-bottom: 1px solid var(--border); text-align: center; }
        .attendance-table input { width: 100%; border: none; text-align: center; background: transparent; padding: 5px; font-family: monospace; font-size: 1rem; }
        .attendance-table input:focus { background: #eff6ff; }

        /* الطباعة */
        .preview-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .salary-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); page-break-inside: avoid; }
        .card-header { background-color: var(--primary); color: white; padding: 12px; text-align: center; font-weight: 800; border-bottom: 1px solid #000; }
        .card-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .card-table tr { border-bottom: 1px solid #e2e8f0; }
        .label-col { background-color: #f8fafc; width: 55%; padding: 8px 12px; text-align: right; font-weight: 600; color: #475569; border-left: 1px solid #e2e8f0; }
        .value-col { width: 45%; padding: 8px 12px; text-align: center; font-weight: 700; color: #0f172a; font-family: monospace; }
        .net-row td { background-color: #ecfdf5; border-top: 2px solid #000; padding: 12px; font-size: 1.1rem; }

        /* تحسينات الإعدادات */
        .backup-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .backup-title { color: #166534; font-weight: bold; margin-bottom: 10px; display: block; }

        @media print {
            .sidebar, .main-content > div:not(#printView), .no-print, .filters-header, button { display: none !important; }
            body, .main-content { margin: 0; padding: 0; background: white; width: 100%; }
            #printView, #printPreviewContainer { display: block !important; }
            .preview-wrapper { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 10px !important; }
            .salary-card { border: 2px solid #000 !important; box-shadow: none !important; margin-bottom: 10px; }
            .card-header { background-color: #eee !important; color: #000 !important; border-bottom: 2px solid #000 !important; }
            .card-table tr { border-bottom: 1px solid #000 !important; }
            .label-col { background-color: transparent !important; color: #000 !important; border-left: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <!-- القائمة الجانبية -->
    <div class="sidebar no-print">
        <div class="brand">
            <i class="fa-solid fa-sack-dollar"></i>
            <span>Fingerprint sheet Mahmoud</span>
        </div>
        <nav>
            <li class="active" onclick="switchView('main')"><i class="fa-solid fa-users"></i> الموظفين</li>
            <li onclick="switchView('print')"><i class="fa-solid fa-print"></i> طباعة الرواتب</li>
            <li onclick="switchView('settings')"><i class="fa-solid fa-gear"></i> الإعدادات والنسخ</li>
        </nav>
    </div>

    <!-- المحتوى -->
    <div class="main-content">
        
        <!-- === قسم الموظفين === -->
        <div id="mainView">
            <div class="card no-print">
                <div class="filters-header">
                    <div class="input-group">
                        <label>الفرع الحالي</label>
                        <select id="branchSelect" onchange="renderEmployees()"></select>
                    </div>
                    <div class="input-group">
                        <label>شهر الراتب</label>
                        <input type="month" id="monthSelect" onchange="renderEmployees()">
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-success" onclick="document.getElementById('excelInput').click()">
                        <i class="fa-solid fa-file-excel"></i> استيراد بصمة (Excel)
                    </button>
                    <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls">
                    <button class="btn-secondary" onclick="resetForm()">
                        <i class="fa-solid fa-plus"></i> موظف جديد
                    </button>
                </div>
            </div>

            <div class="workspace">
                <!-- القائمة الجانبية للموظفين -->
                <div class="card no-print">
                    <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #eee; font-weight:bold">
                        موظفي الفرع
                        <span style="font-size:0.7rem; color:#666; display:block; font-weight:normal">اللون الأخضر: تم تسجيله لهذا الشهر</span>
                    </div>
                    <ul class="emp-list" id="employeesList"></ul>
                </div>

                <!-- نموذج الإدخال -->
                <div class="card form-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">
                        <h2 id="formTitle" style="font-size:1.4rem; color:var(--primary)">موظف جديد</h2>
                        <button class="btn-danger" onclick="deleteEmployeeRecord()">
                            <i class="fa-solid fa-trash"></i> حذف سجل الشهر
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="section-header">البيانات الأساسية (ثابتة)</div>
                        <div class="input-group"><label>اسم الموظف</label><input type="text" id="empName"></div>
                        <div class="input-group"><label>رقم البصمة (ID)</label><input type="number" id="empId" placeholder="هام جداً للربط"></div>
                        <div class="input-group"><label>المسمى الوظيفي</label><input type="text" id="jobTitle"></div>
                        
                        <div class="section-header">الاستحقاقات (لهذا الشهر)</div>
                        <div class="input-group"><label>اليومية (ج.م)</label><input type="number" id="dailyWage"></div>
                        <div class="input-group"><label>حوافز / إضافي مالي</label><input type="number" id="bonus"></div>
                        
                        <div class="section-header">الخصومات (لهذا الشهر)</div>
                        <div class="input-group"><label>إجمالي السلف</label><input type="number" id="loans"></div>
                        <div class="input-group"><label>تقسيط السلفة (شهور)</label><input type="number" id="loanMonths" value="1"></div>
                        <div class="input-group"><label>خصم تأمينات</label><input type="number" id="insurance"></div>
                        <div class="input-group"><label>سحب يوم 10</label><input type="number" id="withdraw10"></div>
                        <div class="input-group"><label>سحب يوم 20</label><input type="number" id="withdraw20"></div>
                        <div class="input-group"><label>جزاءات / خصم عام</label><input type="number" id="generalDeduct"></div>
                    </div>

                    <!-- جدول البصمة -->
                    <div style="margin-top:20px">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <h4 style="margin:0">سجل الحضور والانصراف</h4>
                            <button class="btn-secondary" onclick="loadAttendanceFromMemory()" style="padding:5px 10px; font-size:0.8rem">
                                <i class="fa-solid fa-sync"></i> جلب البصمة
                            </button>
                        </div>
                        <div class="table-wrap" style="max-height:300px; overflow-y:auto">
                            <table class="attendance-table" id="attTable">
                                <thead><tr><th>اليوم</th><th>دخول</th><th>خروج</th><th>ساعات</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top:25px">
                        <button class="btn-save" onclick="saveEmployee()">
                            <i class="fa-solid fa-save"></i> حفظ البيانات لهذا الشهر
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === قسم معاينة الطباعة === -->
        <div id="printView" style="display:none">
            <div class="card no-print" style="padding:30px; text-align:center">
                <h2 style="color:var(--primary); margin-bottom:10px">طباعة الرواتب</h2>
                <div style="display:flex; justify-content:center; gap:20px">
                    <button class="btn-primary" onclick="window.print()">
                        <i class="fa-solid fa-print"></i> طباعة الكروت
                    </button>
                    <button class="btn-secondary" onclick="switchView('main')">عودة</button>
                </div>
            </div>
            <div id="printPreviewContainer" class="preview-wrapper"></div>
        </div>

        <!-- === قسم الإعدادات (نقل البيانات) === -->
        <div id="settingsView" style="display:none">
            <div class="card" style="padding:30px; max-width:800px; margin:0 auto">
                <h3 style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">إدارة الفروع</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px">
                    <input type="text" id="newBranchName" placeholder="اسم الفرع الجديد..." style="flex:1;">
                    <button class="btn-primary" onclick="addBranch()">إضافة</button>
                </div>
                <ul id="branchesListDisplay" style="list-style:none; margin-bottom:30px; border:1px solid #eee; border-radius:8px;"></ul>

                <h3 style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px; color:var(--primary)">
                    <i class="fa-solid fa-database"></i> إدارة البيانات والنسخ الاحتياطي (للفلاشة)
                </h3>
                
                <div class="backup-box">
                    <span class="backup-title">تصدير البيانات (حفظ على الفلاشة)</span>
                    <p style="font-size:0.9rem; margin-bottom:10px">يمكنك حفظ بيانات النظام بالكامل أو فرع محدد لنقله لجهاز آخر.</p>
                    <div style="display:flex; gap:10px">
                        <select id="exportBranchSelect" style="padding:8px; border-radius:6px; border:1px solid #ccc">
                            <option value="all">كل الفروع (نسخة كاملة)</option>
                            <!-- سيتم ملؤها بالجافاسكربت -->
                        </select>
                        <button class="btn-success" onclick="exportData()">
                            <i class="fa-solid fa-download"></i> تحميل الملف
                        </button>
                    </div>
                </div>

                <div class="backup-box" style="background:#fff7ed; border-color:#fed7aa">
                    <span class="backup-title" style="color:#c2410c">استيراد البيانات (استعادة من الفلاشة)</span>
                    <p style="font-size:0.9rem; margin-bottom:10px">تحذير: هذا الخيار سيستبدل البيانات الموجودة بالبيانات الموجودة في الملف.</p>
                    <input type="file" id="jsonInput" accept=".json" style="margin-bottom:10px">
                    <button class="btn-danger" onclick="importData()">
                        <i class="fa-solid fa-upload"></i> استعادة البيانات
                    </button>
                </div>

                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; text-align:center">
                    <button class="btn-danger" onclick="clearAllData()" style="margin:0 auto">
                        <i class="fa-solid fa-trash-can"></i> حذف كافة بيانات النظام (تهيئة المصنع)
                    </button>
                </div>
            </div>
        </div>

    </div>

<script>
    // === المتغيرات وقاعدة البيانات ===
    // employees: سيحتوي على سجلات كل شهر. الهيكل: { id, name, branch, month, ...data }
    let employees = [];
    let attendanceData = {}; 
    let branches = ['الفرع الرئيسي', 'فرع مدينة نصر', 'فرع التجمع'];
    
    document.addEventListener('DOMContentLoaded', () => {
        loadDB();
        // ضبط التاريخ الافتراضي
        const d = new Date();
        document.getElementById('monthSelect').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        updateUI();
        setupExcel();
        initAttTable();
    });

    // === تحميل وحفظ البيانات ===
    function loadDB() {
        if(localStorage.getItem('HR_Emps_V4')) employees = JSON.parse(localStorage.getItem('HR_Emps_V4'));
        if(localStorage.getItem('HR_Att_V4')) attendanceData = JSON.parse(localStorage.getItem('HR_Att_V4'));
        if(localStorage.getItem('HR_Branches_V4')) branches = JSON.parse(localStorage.getItem('HR_Branches_V4'));
    }
    function saveDB() {
        localStorage.setItem('HR_Emps_V4', JSON.stringify(employees));
        localStorage.setItem('HR_Att_V4', JSON.stringify(attendanceData));
        localStorage.setItem('HR_Branches_V4', JSON.stringify(branches));
    }

    // === واجهة المستخدم ===
    function switchView(view) {
        document.getElementById('mainView').style.display = view === 'main' ? 'block' : 'none';
        document.getElementById('printView').style.display = view === 'print' ? 'block' : 'none';
        document.getElementById('settingsView').style.display = view === 'settings' ? 'block' : 'none';
        
        document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
        if(view === 'main') document.querySelector('.sidebar li:nth-child(1)').classList.add('active');
        if(view === 'print') {
            document.querySelector('.sidebar li:nth-child(2)').classList.add('active');
            preparePrint();
        }
        if(view === 'settings') {
            document.querySelector('.sidebar li:nth-child(3)').classList.add('active');
            updateExportOptions();
        }
    }

    function updateUI() {
        const sel = document.getElementById('branchSelect');
        const curr = sel.value;
        sel.innerHTML = '';
        branches.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
        if(branches.includes(curr)) sel.value = curr; else if(branches.length>0) sel.value = branches[0];

        const list = document.getElementById('branchesListDisplay');
        list.innerHTML = '';
        branches.forEach(b => {
            list.innerHTML += `<li style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center">
                <span>${b}</span> <button class="btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="delBranch('${b}')"><i class="fa-solid fa-trash"></i></button>
            </li>`;
        });
        
        renderEmployees();
    }

    function updateExportOptions() {
        const sel = document.getElementById('exportBranchSelect');
        sel.innerHTML = '<option value="all">كل الفروع (نسخة كاملة)</option>';
        branches.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
    }

    // === جوهر النظام: إدارة الموظفين الذكية ===
    function renderEmployees() {
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        const list = document.getElementById('employeesList');
        list.innerHTML = '';

        // 1. الحصول على جميع الموظفين الذين عملوا في هذا الفرع (بغض النظر عن الشهر)
        // نستخدم Set لضمان عدم التكرار
        const uniqueIds = new Set();
        const branchEmployees = [];

        // البحث في السجلات لإيجاد كل من انتمى لهذا الفرع
        employees.forEach(e => {
            if (e.branch === branch && !uniqueIds.has(e.id)) {
                uniqueIds.add(e.id);
                branchEmployees.push({ id: e.id, name: e.name });
            }
        });

        if(branchEmployees.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#999; display:block">لا يوجد موظفين في هذا الفرع. أضف موظف جديد.</li>';
            return;
        }

        // ترتيب أبجدي
        branchEmployees.sort((a,b) => a.name.localeCompare(b.name));

        branchEmployees.forEach(masterEmp => {
            // هل يوجد له سجل في الشهر المحدد؟
            const hasRecord = employees.some(e => e.id === masterEmp.id && e.branch === branch && e.month === month);
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <span style="font-weight:bold">${masterEmp.name}</span>
                    <br><span style="font-size:0.8rem; color:#666">كود: ${masterEmp.id}</span>
                </div>
                <div class="status-dot ${hasRecord ? 'status-active' : 'status-inactive'}" title="${hasRecord ? 'تم التسجيل' : 'لم يسجل لهذا الشهر'}"></div>
            `;
            li.onclick = () => loadEmpForm(masterEmp.id);
            
            // تحديد العنصر النشط
            if(document.getElementById('empId').value == masterEmp.id) li.classList.add('selected');
            
            list.appendChild(li);
        });
    }

    function resetForm() {
        document.querySelectorAll('.form-grid input').forEach(i => i.value = '');
        document.getElementById('loanMonths').value = '1';
        document.getElementById('formTitle').innerText = 'موظف جديد';
        document.getElementById('empId').disabled = false;
        initAttTable();
        document.querySelectorAll('.emp-list li').forEach(li => li.classList.remove('selected'));
    }

    function loadEmpForm(id) {
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        // محاولة العثور على سجل الشهر الحالي
        let emp = employees.find(e => e.id === id && e.branch === branch && e.month === month);
        
        if (emp) {
            // === الحالة 1: الموظف موجود في الشهر الحالي ===
            fillForm(emp);
            document.getElementById('formTitle').innerText = 'تعديل: ' + emp.name + ' (' + month + ')';
        } else {
            // === الحالة 2: الموظف غير موجود في هذا الشهر، نبحث عن آخر بيانات له ===
            // نبحث عن أي سجل سابق لهذا الموظف لننسخ منه البيانات الثابتة
            const prevRecords = employees.filter(e => e.id === id);
            if (prevRecords.length > 0) {
                const lastRec = prevRecords[prevRecords.length - 1]; // آخر سجل مضاف
                
                // نملأ النموذج ببياناته القديمة لكن نصفر المتغيرات
                document.getElementById('empName').value = lastRec.name;
                document.getElementById('empId').value = lastRec.id;
                document.getElementById('jobTitle').value = lastRec.job;
                document.getElementById('dailyWage').value = lastRec.financials.wage;
                document.getElementById('loanMonths').value = lastRec.financials.loanMonths || 1;
                document.getElementById('insurance').value = lastRec.financials.insurance || 0;
                
                // تصفير المتغيرات الشهرية
                document.getElementById('bonus').value = '';
                document.getElementById('loans').value = '';
                document.getElementById('withdraw10').value = '';
                document.getElementById('withdraw20').value = '';
                document.getElementById('generalDeduct').value = '';
                
                document.getElementById('formTitle').innerText = 'تسجيل شهر جديد: ' + lastRec.name;
                initAttTable(); // جدول فارغ
            }
        }
        
        document.getElementById('empId').disabled = true; // منع تغيير الكود للحفاظ على الاتساق
        renderEmployees(); // لتحديث التظليل
        
        // تظليل العنصر المختار يدوياً لأنه قد يعاد رسم القائمة
        setTimeout(() => {
            const listItems = document.querySelectorAll('.emp-list li');
            listItems.forEach(li => {
                if(li.innerText.includes(id)) li.classList.add('selected');
            });
        }, 50);
    }

    function fillForm(emp) {
        document.getElementById('empName').value = emp.name;
        document.getElementById('empId').value = emp.id;
        document.getElementById('jobTitle').value = emp.job;
        document.getElementById('dailyWage').value = emp.financials.wage;
        document.getElementById('bonus').value = emp.financials.bonus;
        document.getElementById('loans').value = emp.financials.loans;
        document.getElementById('loanMonths').value = emp.financials.loanMonths;
        document.getElementById('insurance').value = emp.financials.insurance;
        document.getElementById('withdraw10').value = emp.financials.withdraw10;
        document.getElementById('withdraw20').value = emp.financials.withdraw20;
        document.getElementById('generalDeduct').value = emp.financials.deduct;

        initAttTable();
        if(emp.att) {
            Object.entries(emp.att).forEach(([day, val]) => {
                const tr = document.querySelector(`tr[data-day="${day}"]`);
                if(tr) {
                    tr.querySelector('.in').value = val.in;
                    tr.querySelector('.out').value = val.out;
                    calcRow(tr);
                }
            });
        }
    }

    function saveEmployee() {
        const id = document.getElementById('empId').value.trim();
        const name = document.getElementById('empName').value.trim();
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;

        if(!id || !name) return alert('يرجى إدخال الاسم ورقم البصمة');

        // حذف السجل القديم لنفس الشهر والفرع والكود (إن وجد) لتحديثه
        employees = employees.filter(e => !(e.id === id && e.branch === branch && e.month === month));

        const emp = {
            id, name, branch, month,
            job: document.getElementById('jobTitle').value,
            financials: {
                wage: Number(document.getElementById('dailyWage').value),
                bonus: Number(document.getElementById('bonus').value),
                loans: Number(document.getElementById('loans').value),
                loanMonths: Number(document.getElementById('loanMonths').value) || 1,
                insurance: Number(document.getElementById('insurance').value),
                withdraw10: Number(document.getElementById('withdraw10').value),
                withdraw20: Number(document.getElementById('withdraw20').value),
                deduct: Number(document.getElementById('generalDeduct').value),
            },
            att: getAttTableData()
        };

        employees.push(emp);
        saveDB();
        renderEmployees();
        alert('تم الحفظ بنجاح');
        
        // إعادة تحميل النموذج للتأكيد
        loadEmpForm(id);
    }
    
    function deleteEmployeeRecord() {
        const id = document.getElementById('empId').value;
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        if(!id) return;

        if(!confirm('هل أنت متأكد من حذف بيانات هذا الشهر فقط؟ (لن يتم حذف الموظف نهائياً من القائمة)')) return;
        
        // نحذف فقط سجل هذا الشهر
        employees = employees.filter(e => !(e.id === id && e.branch === branch && e.month === month));
        saveDB();
        resetForm();
        renderEmployees();
    }

    // === جدول البصمة اليدوي ===
    function initAttTable() {
        const tbody = document.querySelector('#attTable tbody');
        tbody.innerHTML = '';
        for(let i=1; i<=31; i++) {
            tbody.innerHTML += `<tr data-day="${i}">
                <td>${i}</td>
                <td><input type="time" class="in" onchange="calcRow(this.closest('tr'))"></td>
                <td><input type="time" class="out" onchange="calcRow(this.closest('tr'))"></td>
                <td class="hours" style="font-weight:bold; color:#666">0.00</td>
            </tr>`;
        }
    }

    function calcRow(tr) {
        const i = tr.querySelector('.in').value;
        const o = tr.querySelector('.out').value;
        const hCell = tr.querySelector('.hours');
        if(i && o) {
            let d1 = new Date(`2000-01-01T${i}`);
            let d2 = new Date(`2000-01-01T${o}`);
            let diff = (d2 - d1) / 36e5;
            if(diff < 0) diff += 24;
            hCell.innerText = diff.toFixed(2);
        } else {
            hCell.innerText = '0.00';
        }
    }

    function getAttTableData() {
        const data = {};
        document.querySelectorAll('#attTable tbody tr').forEach(tr => {
            const i = tr.querySelector('.in').value;
            const o = tr.querySelector('.out').value;
            if(i || o) data[tr.dataset.day] = {in:i, out:o};
        });
        return data;
    }

    // === استيراد الإكسيل والذاكرة ===
    function setupExcel() {
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedBranch = document.getElementById('branchSelect').value;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const workbook = XLSX.read(evt.target.result, {type:'array'});
                const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
                
                let count = 0;
                sheet.forEach((row, idx) => {
                    if(idx === 0) return;
                    let id = row[2]; // افتراض أن الكود في العمود 3
                    let dateRaw = row[3]; // افتراض أن التاريخ في العمود 4

                    if(id && dateRaw) {
                        id = id.toString().trim();
                        let dateObj = typeof dateRaw === 'number' ? new Date((dateRaw - 25569)*86400*1000) : new Date(dateRaw);
                        
                        if(!isNaN(dateObj)) {
                            const recMonth = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                            if(recMonth === selectedMonth) {
                                // حفظ البيانات في الذاكرة العامة للبصمة مربوطة بالفرع والكود
                                const uniqueKey = selectedBranch + '_' + id;
                                if(!attendanceData[uniqueKey]) attendanceData[uniqueKey] = {};
                                const dateKey = recMonth + '-' + String(dateObj.getDate()).padStart(2,'0');
                                if(!attendanceData[uniqueKey][dateKey]) attendanceData[uniqueKey][dateKey] = [];
                                attendanceData[uniqueKey][dateKey].push(dateObj.toString());
                                count++;
                            }
                        }
                    }
                });
                saveDB();
                alert(`تم استيراد ${count} حركة لهذا الشهر والفرع.`);
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
    }

    function loadAttendanceFromMemory() {
        const id = document.getElementById('empId').value;
        const branch = document.getElementById('branchSelect').value;
        const uniqueKey = branch + '_' + id;

        if(!id || !attendanceData[uniqueKey]) return alert('لا توجد بيانات بصمة محفوظة لهذا الكود في هذا الفرع.');

        const month = document.getElementById('monthSelect').value;
        const dates = attendanceData[uniqueKey];
        
        let found = false;
        Object.keys(dates).forEach(dateKey => {
            if(dateKey.startsWith(month)) {
                found = true;
                const day = parseInt(dateKey.split('-')[2]);
                const times = dates[dateKey].map(t => new Date(t)).sort((a,b)=>a-b);
                const tr = document.querySelector(`tr[data-day="${day}"]`);
                if(tr && times.length > 0) {
                    const t1 = times[0];
                    tr.querySelector('.in').value = `${String(t1.getHours()).padStart(2,'0')}:${String(t1.getMinutes()).padStart(2,'0')}`;
                    if(times.length > 1) {
                        const t2 = times[times.length-1];
                        tr.querySelector('.out').value = `${String(t2.getHours()).padStart(2,'0')}:${String(t2.getMinutes()).padStart(2,'0')}`;
                    }
                    calcRow(tr);
                }
            }
        });
        if(!found) alert('لا توجد بصمات لهذا الشهر.');
    }

    // === الطباعة ===
    function preparePrint() {
        const container = document.getElementById('printPreviewContainer');
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        // نجلب فقط الموظفين الذين لديهم بيانات مسجلة لهذا الشهر
        const filtered = employees.filter(e => e.branch === branch && e.month === month);
        
        if(filtered.length === 0) {
            container.innerHTML = '<p style="grid-column:1/-1; text-align:center">لا توجد رواتب مسجلة لهذا الشهر والفرع.</p>';
            return;
        }

        let html = '';
        filtered.forEach(emp => {
            const c = calculateSalary(emp);
            html += `
            <div class="salary-card">
                <div class="card-header">${emp.name}</div>
                <div class="card-body">
                    <table class="card-table">
                        <tr> <td class="value-col">${emp.branch}</td> <td class="label-col">الفرع</td> </tr>
                        <tr> <td class="value-col">${emp.month}</td> <td class="label-col">الشهر</td> </tr>
                        <tr> <td class="value-col">${c.workDays}</td> <td class="label-col">أيام العمل</td> </tr>
                        <tr> <td class="value-col">${c.overtimeHours.toFixed(2)}</td> <td class="label-col">ساعات إضافية</td> </tr>
                        <tr> <td class="value-col">${c.delayHours.toFixed(2)}</td> <td class="label-col">ساعات تأخير</td> </tr>
                        <tr> <td class="value-col">${c.basicSalary.toFixed(2)}</td> <td class="label-col">الأساسي</td> </tr>
                        <tr> <td class="value-col" style="color:green">${emp.financials.bonus.toFixed(2)}</td> <td class="label-col">إضافي</td> </tr>
                        <tr> <td class="value-col" style="color:red">${c.delayValue.toFixed(2)}</td> <td class="label-col">خصم تأخير</td> </tr>
                        <tr> <td class="value-col" style="color:red">${c.loanDeduct.toFixed(2)}</td> <td class="label-col">سلف</td> </tr>
                        <tr> <td class="value-col" style="color:red">${emp.financials.insurance.toFixed(2)}</td> <td class="label-col">تأمينات</td> </tr>
                        <tr> <td class="value-col" style="color:red">${emp.financials.deduct.toFixed(2)}</td> <td class="label-col">جزاءات</td> </tr>
                        <tr> <td class="value-col" style="color:red">${(emp.financials.withdraw10 + emp.financials.withdraw20).toFixed(2)}</td> <td class="label-col">مسحوبات</td> </tr>
                        <tr class="net-row"> 
                            <td class="value-col">${c.net.toFixed(2)}</td> 
                            <td class="label-col">الصافي</td> 
                        </tr>
                    </table>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function calculateSalary(emp) {
        let workDays = 0, overtimeHours = 0, delayHours = 0;
        if(emp.att) {
            Object.values(emp.att).forEach(v => {
                if(v.in && v.out) {
                    workDays++;
                    let d1 = new Date("2000-01-01T"+v.in);
                    let d2 = new Date("2000-01-01T"+v.out);
                    let hours = (d2 - d1) / 36e5;
                    if(hours < 0) hours += 24;
                    if(hours > 8) overtimeHours += (hours - 8);
                    if(hours < 8) delayHours += (8 - hours);
                }
            });
        }
        const wage = emp.financials.wage || 0;
        const basicSalary = workDays * wage;
        const hourlyRate = wage / 8;
        const delayValue = delayHours * hourlyRate;
        const loanDeduct = (emp.financials.loans || 0) / (emp.financials.loanMonths || 1);
        
        const totalDeductions = delayValue + loanDeduct + (emp.financials.insurance || 0) + (emp.financials.deduct || 0) + (emp.financials.withdraw10 || 0) + (emp.financials.withdraw20 || 0);
        const net = (basicSalary + (emp.financials.bonus || 0)) - totalDeductions;

        return { workDays, basicSalary, overtimeHours, delayHours, delayValue, loanDeduct, net };
    }

    // === إدارة البيانات (تصدير واستيراد) ===
    function exportData() {
        const branchToExport = document.getElementById('exportBranchSelect').value;
        
        let dataToSave = {
            branches: branches
        };

        if(branchToExport === 'all') {
            // تصدير كل شيء
            dataToSave.employees = employees;
            dataToSave.attendance = attendanceData;
        } else {
            // تصدير فرع محدد فقط
            dataToSave.employees = employees.filter(e => e.branch === branchToExport);
            
            // فلترة البصمة الخاصة بهذا الفرع
            const filteredAtt = {};
            Object.keys(attendanceData).forEach(key => {
                if(key.startsWith(branchToExport + '_')) {
                    filteredAtt[key] = attendanceData[key];
                }
            });
            dataToSave.attendance = filteredAtt;
            
            // التأكد من وجود الفرع في القائمة
            dataToSave.branches = [branchToExport];
        }

        const dataStr = JSON.stringify(dataToSave);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().split('T')[0];
        a.download = `Backup_${branchToExport}_${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData() {
        const input = document.getElementById('jsonInput');
        if(!input.files.length) return alert('يرجى اختيار ملف .json أولاً');
        
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if(confirm('هل أنت متأكد؟ سيتم استبدال البيانات الحالية بالبيانات الموجودة في الملف.')) {
                    // تحديث البيانات
                    if(data.employees) employees = data.employees;
                    if(data.attendance) attendanceData = data.attendance;
                    if(data.branches) branches = data.branches;
                    
                    saveDB();
                    alert('تم استعادة البيانات بنجاح!');
                    location.reload(); // إعادة تحميل الصفحة لتطبيق التغييرات
                }
            } catch(err) {
                alert('حدث خطأ أثناء قراءة الملف. تأكد أنه ملف صحيح.');
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if(confirm('تحذير نهائي: هل تريد حذف كل البيانات والبدء من جديد؟ لا يمكن التراجع عن هذا الإجراء.')) {
            localStorage.clear();
            location.reload();
        }
    }

    // === إدارة الفروع ===
    function addBranch() {
        const name = document.getElementById('newBranchName').value;
        if(name && !branches.includes(name)) { 
            branches.push(name); 
            saveDB(); 
            updateUI(); 
            updateExportOptions();
            document.getElementById('newBranchName').value = ''; 
        }
    }
    function delBranch(name) {
        if(confirm('هل أنت متأكد من حذف الفرع؟ لن يتم حذف بيانات الموظفين المسجلين عليه لكن لن يظهر في القائمة.')) { 
            branches = branches.filter(b => b !== name); 
            saveDB(); 
            updateUI(); 
            updateExportOptions();
        }
    }
</script>
</body>
</html>
