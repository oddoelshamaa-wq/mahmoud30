html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Sheet - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1e3a8a; --primary-light: #3b82f6; --bg-body: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b; --success: #15803d; --danger: #b91c1c; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); direction: rtl; display: flex; min-height: 100vh; }
        
        /* === Login Overlay === */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .login-box button:hover { background: var(--primary-light); }
        .error-msg { color: red; font-size: 0.9rem; margin-top: 10px; display: none; }

        /* === Sidebar & Layout === */
        .sidebar { width: 260px; background: #0f172a; color: white; height: 100vh; position: fixed; right: 0; top: 0; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar .brand { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: bold; }
        .sidebar nav { padding: 10px; flex: 1; }
        .sidebar nav li { padding: 12px 20px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; font-weight: 500; }
        .sidebar nav li:hover, .sidebar nav li.active { background: var(--primary-light); color: white; }
        .user-info { padding: 15px; background: rgba(255,255,255,0.05); font-size: 0.8rem; text-align: center; color: #94a3b8; }
        
        /* === Main Content === */
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; display: none; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 25px; }
        
        /* === Filters & Buttons === */
        .filters-header { background: #fff; padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; border-bottom: 1px solid #f1f5f9; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: #64748b; }
        .input-group input, .input-group select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; min-width: 160px; font-family: inherit; font-size: 0.95rem; }
        button { border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: bold; display: flex; gap: 8px; align-items: center; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: #334155; }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-success { background: #dcfce7; color: #166534; }
        .btn-save { background: #0f172a; color: white; width: 100%; justify-content: center; padding: 12px; font-size: 1rem; }

        /* === Workspace === */
        .workspace { display: grid; grid-template-columns: 280px 1fr; gap: 25px; align-items: start; }
        .emp-list { list-style: none; height: 600px; overflow-y: auto; padding: 10px; }
        .emp-list li { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items:center; border-radius: 6px; margin-bottom: 4px; transition: 0.1s; }
        .emp-list li:hover { background: #f1f5f9; }
        .emp-list li.selected { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-left:5px; }
        .status-active { background-color: var(--success); }
        .status-inactive { background-color: #cbd5e1; }

        /* === Forms & Tables === */
        .form-container { padding: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .section-header { grid-column: 1/-1; margin: 15px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; color: var(--primary); font-weight: bold; font-size: 1rem; }
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .attendance-table th { background: #f8fafc; padding: 10px; text-align: center; border-bottom: 1px solid var(--border); font-weight: 700; }
        .attendance-table td { padding: 5px; border-bottom: 1px solid var(--border); text-align: center; }
        .attendance-table input { width: 100%; border: none; text-align: center; background: transparent; padding: 5px; font-family: monospace; font-size: 1rem; }
        
        /* === Print === */
        .preview-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .salary-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .card-header { background-color: var(--primary); color: white; padding: 12px; text-align: center; font-weight: 800; border-bottom: 1px solid #000; }
        .card-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .card-table tr { border-bottom: 1px solid #e2e8f0; }
        .label-col { background-color: #f8fafc; width: 55%; padding: 8px 12px; text-align: right; font-weight: 600; color: #475569; border-left: 1px solid #e2e8f0; }
        .value-col { width: 45%; padding: 8px 12px; text-align: center; font-weight: 700; color: #0f172a; font-family: monospace; }
        
        @media print {
            .sidebar, .main-content > div:not(#printView), .no-print, .filters-header, button { display: none !important; }
            body, .main-content { margin: 0; padding: 0; background: white; width: 100%; }
            #printView, #printPreviewContainer { display: block !important; }
            .preview-wrapper { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 15px !important; }
            .salary-card { border: 2px solid #000 !important; box-shadow: none !important; margin-bottom: 10px; page-break-inside: avoid; }
            .card-header { background-color: #eee !important; color: #000 !important; border-bottom: 2px solid #000 !important; -webkit-print-color-adjust: exact; }
            .card-table tr { border-bottom: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <!-- شاشة تسجيل الدخول -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin-bottom:20px; color:var(--primary)">نظام الرواتب (Online)</h2>
            <p style="font-size:0.8rem; margin-bottom:15px; color:#666">ادخل بحساب admin@app.com لإنشاء باقي الحسابات</p>
            <input type="email" id="loginEmail" placeholder="البريد الإلكتروني (مثلاً admin@app.com)">
            <input type="password" id="loginPassword" placeholder="كلمة المرور">
            <button id="btnLogin">تسجيل الدخول</button>
            <p class="error-msg" id="loginError"></p>
        </div>
    </div>

    <!-- القائمة الجانبية -->
    <div class="sidebar no-print">
        <div class="brand">
            <i class="fa-solid fa-cloud"></i>
            <span>Fingerprint Sheet</span>
        </div>
        <nav>
            <li class="active" onclick="switchView('main')"><i class="fa-solid fa-users"></i> الموظفين</li>
            <li onclick="switchView('print')"><i class="fa-solid fa-print"></i> طباعة الرواتب</li>
            <li onclick="switchView('settings')"><i class="fa-solid fa-gear"></i> الإعدادات والمستخدمين</li>
        </nav>
        <div class="user-info">
            <span id="userEmailDisplay">...</span><br>
            <a href="#" onclick="logoutApp()" style="color:#f87171; text-decoration:none">تسجيل خروج</a>
        </div>
    </div>

    <!-- المحتوى -->
    <div class="main-content" id="appContent">
        
        <!-- === قسم الموظفين === -->
        <div id="mainView">
            <div class="card no-print">
                <div class="filters-header">
                    <div class="input-group">
                        <label>الفرع الحالي</label>
                        <select id="branchSelect" onchange="renderEmployees()"></select>
                    </div>
                    <div class="input-group">
                        <label>شهر الراتب</label>
                        <input type="month" id="monthSelect" onchange="renderEmployees()">
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-success" onclick="document.getElementById('excelInput').click()">
                        <i class="fa-solid fa-file-excel"></i> استيراد بصمة (Excel)
                    </button>
                    <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls">
                    <button class="btn-secondary" onclick="resetForm()">
                        <i class="fa-solid fa-plus"></i> موظف جديد
                    </button>
                </div>
            </div>

            <div class="workspace">
                <div class="card no-print">
                    <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #eee; font-weight:bold; display:flex; justify-content:space-between">
                        <span>موظفي الفرع</span>
                        <span style="font-size:0.8rem; color:green" id="syncStatus">متصل <i class="fa-solid fa-wifi"></i></span>
                    </div>
                    <ul class="emp-list" id="employeesList"></ul>
                </div>

                <div class="card form-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">
                        <h2 id="formTitle" style="font-size:1.4rem; color:var(--primary)">موظف جديد</h2>
                        <button class="btn-danger" onclick="deleteEmployeeRecord()" id="btnDelete" style="display:none">
                            <i class="fa-solid fa-trash"></i> حذف سجل الشهر
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="section-header">البيانات الأساسية</div>
                        <div class="input-group"><label>اسم الموظف</label><input type="text" id="empName"></div>
                        <div class="input-group"><label>رقم البصمة (ID)</label><input type="number" id="empId" placeholder="هام للربط"></div>
                        <div class="input-group"><label>المسمى الوظيفي</label><input type="text" id="jobTitle"></div>
                        
                        <div class="section-header">الاستحقاقات (لهذا الشهر)</div>
                        <div class="input-group"><label>اليومية (ج.م)</label><input type="number" id="dailyWage"></div>
                        <div class="input-group"><label>حوافز / إضافي</label><input type="number" id="bonus"></div>
                        
                        <div class="section-header">الخصومات (لهذا الشهر)</div>
                        <div class="input-group"><label>إجمالي السلف</label><input type="number" id="loans"></div>
                        <div class="input-group"><label>تقسيط السلفة (شهور)</label><input type="number" id="loanMonths" value="1"></div>
                        <div class="input-group"><label>تأمينات</label><input type="number" id="insurance"></div>
                        <div class="input-group"><label>سحب يوم 10</label><input type="number" id="withdraw10"></div>
                        <div class="input-group"><label>سحب يوم 20</label><input type="number" id="withdraw20"></div>
                        <div class="input-group"><label>جزاءات</label><input type="number" id="generalDeduct"></div>
                    </div>

                    <div style="margin-top:20px">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <h4 style="margin:0">سجل الحضور</h4>
                            <button class="btn-secondary" onclick="loadAttendanceFromDB()" style="padding:5px 10px; font-size:0.8rem">
                                <i class="fa-solid fa-cloud-download"></i> جلب البصمة
                            </button>
                        </div>
                        <div class="table-wrap" style="max-height:300px; overflow-y:auto">
                            <table class="attendance-table" id="attTable">
                                <thead><tr><th>اليوم</th><th>دخول</th><th>خروج</th><th>ساعات</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top:25px">
                        <button class="btn-save" onclick="saveEmployee()">
                            <i class="fa-solid fa-save"></i> حفظ البيانات (Cloud)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === قسم الطباعة === -->
        <div id="printView" style="display:none">
            <div class="card no-print" style="padding:30px; text-align:center">
                <h2 style="color:var(--primary); margin-bottom:10px">طباعة الرواتب</h2>
                <div style="display:flex; justify-content:center; gap:20px">
                    <button class="btn-primary" onclick="window.print()"><i class="fa-solid fa-print"></i> طباعة</button>
                    <button class="btn-secondary" onclick="switchView('main')">عودة</button>
                </div>
            </div>
            <div id="printPreviewContainer" class="preview-wrapper"></div>
        </div>

        <!-- === قسم الإعدادات والمستخدمين === -->
        <div id="settingsView" style="display:none">
            <div class="card" style="padding:30px; max-width:800px; margin:0 auto">
                
                <!-- إضافة مستخدم جديد (ميزة جديدة) -->
                <div style="background:#f0f9ff; border:1px solid #bae6fd; padding:20px; border-radius:8px; margin-bottom:30px">
                    <h3 style="color:#0369a1; margin-bottom:15px"><i class="fa-solid fa-user-plus"></i> إنشاء حساب جديد للموظفين</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end">
                        <div class="input-group">
                            <label>البريد الإلكتروني الجديد</label>
                            <input type="email" id="newUserEmail" placeholder="user@app.com">
                        </div>
                        <div class="input-group">
                            <label>كلمة المرور</label>
                            <input type="text" id="newUserPass" placeholder="******">
                        </div>
                        <button class="btn-primary" onclick="createNewUser()">إنشاء الحساب</button>
                    </div>
                    <p style="font-size:0.8rem; color:#666; margin-top:10px">
                        تنبيه: سيتم تسجيل خروجك تلقائياً عند إنشاء مستخدم جديد لضمان الأمان. يرجى إعادة الدخول بحسابك (admin).
                    </p>
                </div>

                <h3 style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">إدارة الفروع</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px">
                    <input type="text" id="newBranchName" placeholder="اسم الفرع الجديد..." style="flex:1;">
                    <button class="btn-primary" onclick="addBranch()">إضافة</button>
                </div>
                <ul id="branchesListDisplay" style="list-style:none; margin-bottom:30px; border:1px solid #eee; border-radius:8px;"></ul>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZj1ur4bW6YPkWS1JCXLruTZXlZG1pHhY",
      authDomain: "fingerprint-sheet.firebaseapp.com",
      projectId: "fingerprint-sheet",
      storageBucket: "fingerprint-sheet.firebasestorage.app",
      messagingSenderId: "673025647746",
      appId: "1:673025647746:web:a0678f010b6367b932c09b",
      measurementId: "G-3DNFBZB0WJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let employees = []; 
    let branches = ['الفرع الرئيسي']; 
    let attendanceRecords = {};

    // Auth Logic
    const loginOverlay = document.getElementById('loginOverlay');
    const appContent = document.getElementById('appContent');
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginOverlay.style.display = 'none';
            appContent.style.display = 'block';
            document.getElementById('userEmailDisplay').innerText = user.email;
            initApp();
        } else {
            loginOverlay.style.display = 'flex';
            appContent.style.display = 'none';
        }
    });

    btnLogin.addEventListener('click', () => {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPassword').value;
        loginError.style.display = 'none';
        
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => { console.log("Login Success"); })
            .catch((error) => {
                loginError.innerText = "خطأ: تأكد من الإيميل (مثل admin@app.com) وكلمة المرور";
                loginError.style.display = 'block';
            });
    });

    window.logoutApp = () => { signOut(auth).then(() => location.reload()); };

    // === دالة إنشاء مستخدم جديد ===
    window.createNewUser = () => {
        const email = document.getElementById('newUserEmail').value;
        const pass = document.getElementById('newUserPass').value;

        if(!email || !pass) return alert("يرجى كتابة الإيميل وكلمة المرور");

        createUserWithEmailAndPassword(auth, email, pass)
            .then((userCredential) => {
                alert("تم إنشاء الحساب بنجاح! \nسيتم تسجيل الخروج الآن، يرجى الدخول بحساب المدير (admin) مرة أخرى.");
                // Firebase يقوم بتسجيل دخول المستخدم الجديد تلقائياً، لذا يجب الخروج
                signOut(auth);
            })
            .catch((error) => {
                alert("خطأ في الإنشاء: " + error.message);
            });
    };

    // App Logic
    function initApp() {
        const branchesRef = doc(db, "config", "branches");
        onSnapshot(branchesRef, (docSnap) => {
            if (docSnap.exists()) {
                branches = docSnap.data().list || ['الفرع الرئيسي'];
            } else {
                setDoc(branchesRef, { list: ['الفرع الرئيسي'] });
            }
            updateUI();
        });

        const q = query(collection(db, "employees"));
        onSnapshot(q, (querySnapshot) => {
            employees = [];
            querySnapshot.forEach((doc) => {
                employees.push(doc.data());
            });
            renderEmployees();
        });

        const attQ = query(collection(db, "attendance_records"));
        onSnapshot(attQ, (querySnapshot) => {
            attendanceRecords = {};
            querySnapshot.forEach((doc) => {
                attendanceRecords[doc.id] = doc.data();
            });
        });

        const d = new Date();
        document.getElementById('monthSelect').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        initAttTable();
        setupExcel();
    }

    window.switchView = (view) => {
        document.getElementById('mainView').style.display = view === 'main' ? 'block' : 'none';
        document.getElementById('printView').style.display = view === 'print' ? 'block' : 'none';
        document.getElementById('settingsView').style.display = view === 'settings' ? 'block' : 'none';
        
        document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
        if(view === 'main') document.querySelector('.sidebar li:nth-child(1)').classList.add('active');
        if(view === 'print') {
            document.querySelector('.sidebar li:nth-child(2)').classList.add('active');
            preparePrint();
        }
        if(view === 'settings') {
            document.querySelector('.sidebar li:nth-child(3)').classList.add('active');
        }
    };

    function updateUI() {
        const sel = document.getElementById('branchSelect');
        const curr = sel.value;
        sel.innerHTML = '';
        branches.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
        if(branches.includes(curr)) sel.value = curr; else if(branches.length>0) sel.value = branches[0];

        const list = document.getElementById('branchesListDisplay');
        list.innerHTML = '';
        branches.forEach(b => {
            list.innerHTML += `<li style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center">
                <span>${b}</span> <button class="btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="delBranch('${b}')"><i class="fa-solid fa-trash"></i></button>
            </li>`;
        });
        renderEmployees();
    }

    window.renderEmployees = () => {
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        const list = document.getElementById('employeesList');
        list.innerHTML = '';

        const uniqueIds = new Set();
        const branchEmployees = [];

        employees.forEach(e => {
            if (e.branch === branch) {
                if(!uniqueIds.has(e.id)) {
                    uniqueIds.add(e.id);
                    branchEmployees.push({ id: e.id, name: e.name });
                }
            }
        });

        if(branchEmployees.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#999; display:block">لا يوجد بيانات لهذا الفرع.</li>';
            return;
        }

        branchEmployees.sort((a,b) => a.name.localeCompare(b.name));

        branchEmployees.forEach(masterEmp => {
            const docKey = `${masterEmp.id}_${month}`;
            const hasRecord = employees.some(e => e.docKey === docKey && e.branch === branch);
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <span style="font-weight:bold">${masterEmp.name}</span>
                    <br><span style="font-size:0.8rem; color:#666">كود: ${masterEmp.id}</span>
                </div>
                <div class="status-dot ${hasRecord ? 'status-active' : 'status-inactive'}"></div>
            `;
            li.onclick = () => loadEmpForm(masterEmp.id);
            if(document.getElementById('empId').value == masterEmp.id) li.classList.add('selected');
            list.appendChild(li);
        });
    };

    window.resetForm = () => {
        document.querySelectorAll('.form-grid input').forEach(i => i.value = '');
        document.getElementById('loanMonths').value = '1';
        document.getElementById('formTitle').innerText = 'موظف جديد';
        document.getElementById('empId').disabled = false;
        document.getElementById('btnDelete').style.display = 'none';
        initAttTable();
        document.querySelectorAll('.emp-list li').forEach(li => li.classList.remove('selected'));
    };

    window.loadEmpForm = (id) => {
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        const docKey = `${id}_${month}`;
        
        let emp = employees.find(e => e.docKey === docKey && e.branch === branch);
        
        if (emp) {
            fillForm(emp);
            document.getElementById('formTitle').innerText = 'تعديل: ' + emp.name;
            document.getElementById('btnDelete').style.display = 'inline-flex';
        } else {
            const prevRecords = employees.filter(e => e.id == id);
            if (prevRecords.length > 0) {
                const lastRec = prevRecords[prevRecords.length - 1];
                document.getElementById('empName').value = lastRec.name;
                document.getElementById('empId').value = lastRec.id;
                document.getElementById('jobTitle').value = lastRec.job;
                document.getElementById('dailyWage').value = lastRec.financials.wage;
                document.getElementById('insurance').value = lastRec.financials.insurance || 0;
                
                document.getElementById('bonus').value = '';
                document.getElementById('loans').value = '';
                document.getElementById('withdraw10').value = '';
                document.getElementById('withdraw20').value = '';
                document.getElementById('generalDeduct').value = '';
                
                document.getElementById('formTitle').innerText = 'تسجيل شهر جديد: ' + lastRec.name;
                document.getElementById('btnDelete').style.display = 'none';
                initAttTable();
            }
        }
        
        document.getElementById('empId').disabled = true;
        setTimeout(() => {
            document.querySelectorAll('.emp-list li').forEach(li => li.classList.remove('selected'));
            const listItems = document.querySelectorAll('.emp-list li');
            listItems.forEach(li => {
                if(li.innerText.includes(id)) li.classList.add('selected');
            });
        }, 50);
    };

    function fillForm(emp) {
        document.getElementById('empName').value = emp.name;
        document.getElementById('empId').value = emp.id;
        document.getElementById('jobTitle').value = emp.job;
        document.getElementById('dailyWage').value = emp.financials.wage;
        document.getElementById('bonus').value = emp.financials.bonus;
        document.getElementById('loans').value = emp.financials.loans;
        document.getElementById('loanMonths').value = emp.financials.loanMonths;
        document.getElementById('insurance').value = emp.financials.insurance;
        document.getElementById('withdraw10').value = emp.financials.withdraw10;
        document.getElementById('withdraw20').value = emp.financials.withdraw20;
        document.getElementById('generalDeduct').value = emp.financials.deduct;

        initAttTable();
        if(emp.att) {
            Object.entries(emp.att).forEach(([day, val]) => {
                const tr = document.querySelector(`tr[data-day="${day}"]`);
                if(tr) {
                    tr.querySelector('.in').value = val.in;
                    tr.querySelector('.out').value = val.out;
                    calcRow(tr);
                }
            });
        }
    }

    window.saveEmployee = async () => {
        const id = document.getElementById('empId').value.trim();
        const name = document.getElementById('empName').value.trim();
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;

        if(!id || !name) return alert('يرجى إدخال الاسم ورقم البصمة');

        const docKey = `${id}_${month}`;

        const empData = {
            docKey, id, name, branch, month,
            job: document.getElementById('jobTitle').value,
            financials: {
                wage: Number(document.getElementById('dailyWage').value),
                bonus: Number(document.getElementById('bonus').value),
                loans: Number(document.getElementById('loans').value),
                loanMonths: Number(document.getElementById('loanMonths').value) || 1,
                insurance: Number(document.getElementById('insurance').value),
                withdraw10: Number(document.getElementById('withdraw10').value),
                withdraw20: Number(document.getElementById('withdraw20').value),
                deduct: Number(document.getElementById('generalDeduct').value),
            },
            att: getAttTableData()
        };

        try {
            await setDoc(doc(db, "employees", docKey), empData);
            alert('تم الحفظ بنجاح على السيرفر');
        } catch (e) {
            alert("خطأ في الحفظ: " + e.message);
        }
    };

    window.deleteEmployeeRecord = async () => {
        const id = document.getElementById('empId').value;
        const month = document.getElementById('monthSelect').value;
        if(!confirm('هل أنت متأكد من حذف هذا السجل نهائياً من قاعدة البيانات؟')) return;
        
        const docKey = `${id}_${month}`;
        try {
            await deleteDoc(doc(db, "employees", docKey));
            resetForm();
            alert("تم الحذف.");
        } catch(e) {
            alert("خطأ: " + e.message);
        }
    };

    window.addBranch = async () => {
        const name = document.getElementById('newBranchName').value;
        if(name && !branches.includes(name)) {
            const newList = [...branches, name];
            await updateDoc(doc(db, "config", "branches"), { list: newList });
            document.getElementById('newBranchName').value = '';
        }
    };

    window.delBranch = async (name) => {
        if(confirm('حذف الفرع؟')) {
            const newList = branches.filter(b => b !== name);
            await updateDoc(doc(db, "config", "branches"), { list: newList });
        }
    };

    function initAttTable() {
        const tbody = document.querySelector('#attTable tbody');
        tbody.innerHTML = '';
        for(let i=1; i<=31; i++) {
            tbody.innerHTML += `<tr data-day="${i}">
                <td>${i}</td>
                <td><input type="time" class="in" onchange="calcRow(this.closest('tr'))"></td>
                <td><input type="time" class="out" onchange="calcRow(this.closest('tr'))"></td>
                <td class="hours" style="font-weight:bold; color:#666">0.00</td>
            </tr>`;
        }
    }

    window.calcRow = (tr) => {
        const i = tr.querySelector('.in').value;
        const o = tr.querySelector('.out').value;
        const hCell = tr.querySelector('.hours');
        if(i && o) {
            let d1 = new Date(`2000-01-01T${i}`);
            let d2 = new Date(`2000-01-01T${o}`);
            let diff = (d2 - d1) / 36e5;
            if(diff < 0) diff += 24;
            hCell.innerText = diff.toFixed(2);
        } else {
            hCell.innerText = '0.00';
        }
    }

    function getAttTableData() {
        const data = {};
        document.querySelectorAll('#attTable tbody tr').forEach(tr => {
            const i = tr.querySelector('.in').value;
            const o = tr.querySelector('.out').value;
            if(i || o) data[tr.dataset.day] = {in:i, out:o};
        });
        return data;
    }

    function ExcelDateToJSDate(serial) {
        var utc_days  = Math.floor(serial - 25569);
        var utc_value = utc_days * 86400;
        var date_info = new Date(utc_value * 1000);
        return date_info;
    }

    function setupExcel() {
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async function(evt) {
                const workbook = XLSX.read(evt.target.result, {type:'array'});
                const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1, raw:true});
                
                let batchData = {};

                sheet.forEach((row, idx) => {
                    if(idx === 0) return;
                    let id = row[2];
                    let rawDate = row[3];

                    if(id && rawDate) {
                        id = id.toString().trim();
                        let dateObj = typeof rawDate === 'number' ? ExcelDateToJSDate(rawDate) : new Date(rawDate);

                        if(!isNaN(dateObj)) {
                            const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                            const dayKey = dateObj.getDate();
                            const timeStr = dateObj.toTimeString().split(' ')[0].substring(0,5);

                            if(!batchData[id]) batchData[id] = {};
                            if(!batchData[id][monthKey]) batchData[id][monthKey] = {};
                            if(!batchData[id][monthKey][dayKey]) batchData[id][monthKey][dayKey] = [];
                            
                            if(!batchData[id][monthKey][dayKey].includes(timeStr)) {
                                batchData[id][monthKey][dayKey].push(timeStr);
                            }
                        }
                    }
                });

                let promises = [];
                for (const [id, months] of Object.entries(batchData)) {
                    const docRef = doc(db, "attendance_records", id);
                    promises.push(setDoc(docRef, months, { merge: true }));
                }

                try {
                    await Promise.all(promises);
                    alert("تم استيراد ورفع البصمة إلى السيرفر بنجاح!");
                    if(document.getElementById('empId').value) loadAttendanceFromDB();
                } catch(err) {
                    alert("حدث خطأ أثناء الرفع: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
    }

    window.loadAttendanceFromDB = () => {
        const id = document.getElementById('empId').value;
        const month = document.getElementById('monthSelect').value;

        if(!id || !attendanceRecords[id] || !attendanceRecords[id][month]) {
            return alert('لا توجد بصمات محفوظة لهذا الكود في هذا الشهر.');
        }

        const monthData = attendanceRecords[id][month];
        
        Object.entries(monthData).forEach(([day, times]) => {
            const sortedTimes = times.sort();
            const tr = document.querySelector(`tr[data-day="${day}"]`);
            if(tr && sortedTimes.length > 0) {
                tr.querySelector('.in').value = sortedTimes[0];
                if(sortedTimes.length > 1) {
                    tr.querySelector('.out').value = sortedTimes[sortedTimes.length - 1];
                }
                calcRow(tr);
            }
        });
    };

    window.preparePrint = () => {
        const container = document.getElementById('printPreviewContainer');
        const branch = document.getElementById('branchSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        const filtered = employees.filter(e => e.branch === branch && e.month === month);
        
        if(filtered.length === 0) {
            container.innerHTML = '<p style="grid-column:1/-1; text-align:center">لا توجد رواتب مسجلة لهذا الشهر والفرع.</p>';
            return;
        }

        let html = '';
        filtered.forEach(emp => {
            const c = calculateSalary(emp);
            html += `
            <div class="salary-card">
                <div class="card-header">${emp.name}</div>
                <div class="card-body">
                    <table class="card-table">
                        <tr> <td class="value-col">${emp.branch}</td> <td class="label-col">الفرع</td> </tr>
                        <tr> <td class="value-col">${emp.month}</td> <td class="label-col">الشهر</td> </tr>
                        <tr> <td class="value-col">${c.workDays}</td> <td class="label-col">أيام العمل</td> </tr>
                        <tr> <td class="value-col">${c.overtimeHours.toFixed(2)}</td> <td class="label-col">ساعات إضافي</td> </tr>
                        <tr> <td class="value-col">${c.delayHours.toFixed(2)}</td> <td class="label-col">ساعات تأخير</td> </tr>
                        <tr> <td class="value-col">${c.basicSalary.toFixed(2)}</td> <td class="label-col">الأساسي</td> </tr>
                        <tr> <td class="value-col" style="color:green">${emp.financials.bonus.toFixed(2)}</td> <td class="label-col">إضافي مالي</td> </tr>
                        <tr> <td class="value-col" style="color:red">${c.delayValue.toFixed(2)}</td> <td class="label-col">خصم تأخير</td> </tr>
                        <tr> <td class="value-col" style="color:red">${c.loanDeduct.toFixed(2)}</td> <td class="label-col">قسط سلفة</td> </tr>
                        <tr> <td class="value-col" style="color:red">${emp.financials.insurance.toFixed(2)}</td> <td class="label-col">تأمينات</td> </tr>
                        <tr> <td class="value-col" style="color:red">${(emp.financials.withdraw10 + emp.financials.withdraw20 + emp.financials.deduct).toFixed(2)}</td> <td class="label-col">خصومات أخرى</td> </tr>
                        <tr class="net-row"> 
                            <td class="value-col">${c.net.toFixed(2)}</td> 
                            <td class="label-col">الصافي</td> 
                        </tr>
                    </table>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    };

    function calculateSalary(emp) {
        let workDays = 0, overtimeHours = 0, delayHours = 0;
        if(emp.att) {
            Object.values(emp.att).forEach(v => {
                if(v.in && v.out) {
                    workDays++;
                    let d1 = new Date("2000-01-01T"+v.in);
                    let d2 = new Date("2000-01-01T"+v.out);
                    let hours = (d2 - d1) / 36e5;
                    if(hours < 0) hours += 24;
                    if(hours > 8) overtimeHours += (hours - 8);
                    if(hours < 8) delayHours += (8 - hours);
                }
            });
        }
        const wage = emp.financials.wage || 0;
        const basicSalary = workDays * wage;
        const hourlyRate = wage / 8;
        const delayValue = delayHours * hourlyRate;
        const loanDeduct = (emp.financials.loans || 0) / (emp.financials.loanMonths || 1);
        const otherDeducts = (emp.financials.insurance || 0) + (emp.financials.deduct || 0) + (emp.financials.withdraw10 || 0) + (emp.financials.withdraw20 || 0);
        const totalDeductions = delayValue + loanDeduct + otherDeducts;
        const net = (basicSalary + (emp.financials.bonus || 0)) - totalDeductions;
        return { workDays, basicSalary, overtimeHours, delayHours, delayValue, loanDeduct, net };
    }

</script>
</body>
</html>
```

### طريقة الاستخدام بعد التحديث:

1.  **أول مرة فقط:** ادخل بحسابك `admin@app.com` وكلمة المرور `123456`.
2.  **لإضافة موظف:**
    *   افتح القائمة الجانبية -> **الإعدادات والمستخدمين**.
    *   ستجد مربع جديد "إنشاء حساب جديد للموظفين".
    *   اكتب الإيميل الجديد (مثلاً `user1@app.com`) وكلمة المرور.
    *   اضغط **إنشاء الحساب**.
    *   *ملاحظة:* النظام سيقوم بتسجيل خروجك تلقائياً بعد إنشاء الحساب (هذا شرط أمني من جوجل)، قم بالدخول مرة أخرى بحساب المدير.
